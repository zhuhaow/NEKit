<!DOCTYPE html>
<html lang="en">
  <head>
    <title>NEKit  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset="utf-8">
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
    <script src="js/lunr.min.js" defer></script>
    <script src="js/typeahead.jquery.js" defer></script>
    <script src="js/jazzy.search.js" defer></script>
  </head>
  <body>


    <a title="NEKit  Reference"></a>

    <header class="header">
      <p class="header-col header-col--primary">
        <a class="header-link" href="index.html">
          NEKit Docs
        </a>
         (34% documented)
      </p>
    
      <p class="header-col--secondary">
        <form role="search" action="search.json">
          <input type="text" placeholder="Search documentation" data-typeahead>
        </form>
      </p>
    
        <p class="header-col header-col--secondary">
          <a class="header-link" href="https://github.com/zhuhaow/NEKit">
            <img class="header-icon" src="img/gh.png"/>
            View on GitHub
          </a>
        </p>
    
    </header>

    <p class="breadcrumbs">
      <a class="breadcrumb" href="index.html">NEKit Reference</a>
      <img class="carat" src="img/carat.png" />
      NEKit  Reference
    </p>

    <div class="content-wrapper">
      <nav class="navigation">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Proxy Server.html">Proxy Server</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/ProxyServer.html">ProxyServer</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/GCDProxyServer.html">GCDProxyServer</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/GCDSOCKS5ProxyServer.html">GCDSOCKS5ProxyServer</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/GCDHTTPProxyServer.html">GCDHTTPProxyServer</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Socket.html">Socket</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Tunnel.html">Tunnel</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Tunnel/TunnelStatus.html">– TunnelStatus</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/TunnelDelegate.html">TunnelDelegate</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/SocketProtocol.html">SocketProtocol</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/SocketDelegate.html">SocketDelegate</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/ProxySocket.html">ProxySocket</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/DirectProxySocket.html">DirectProxySocket</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/DirectProxySocket/DirectProxyReadStatus.html">– DirectProxyReadStatus</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/DirectProxySocket/DirectProxyWriteStatus.html">– DirectProxyWriteStatus</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/HTTPProxySocket.html">HTTPProxySocket</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/HTTPProxySocket/HTTPProxyReadStatus.html">– HTTPProxyReadStatus</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/HTTPProxySocket/HTTPProxyWriteStatus.html">– HTTPProxyWriteStatus</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SOCKS5ProxySocket.html">SOCKS5ProxySocket</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SOCKS5ProxySocket/SOCKS5ProxyReadStatus.html">– SOCKS5ProxyReadStatus</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SOCKS5ProxySocket/SOCKS5ProxyWriteStatus.html">– SOCKS5ProxyWriteStatus</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/AdapterSocket.html">AdapterSocket</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/DirectAdapter.html">DirectAdapter</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/HTTPAdapter.html">HTTPAdapter</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/HTTPAdapter/HTTPAdapterStatus.html">– HTTPAdapterStatus</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SecureHTTPAdapter.html">SecureHTTPAdapter</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/ShadowsocksAdapter.html">ShadowsocksAdapter</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/ShadowsocksAdapter/ShadowsocksAdapterStatus.html">– ShadowsocksAdapterStatus</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/ShadowsocksAdapter/EncryptMethod.html">– EncryptMethod</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/ShadowsocksAdapter/StreamObfuscater.html">– StreamObfuscater</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/ShadowsocksAdapter/CryptoStreamProcessor.html">– CryptoStreamProcessor</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/ShadowsocksAdapter/ProtocolObfuscater.html">– ProtocolObfuscater</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SpeedAdapter.html">SpeedAdapter</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/SocketStatus.html">SocketStatus</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="AdapterSocketFactory.html">AdapterSocketFactory</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/AdapterFactoryManager.html">AdapterFactoryManager</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/AdapterFactory.html">AdapterFactory</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/DirectAdapterFactory.html">DirectAdapterFactory</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/ServerAdapterFactory.html">ServerAdapterFactory</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/HTTPAdapterFactory.html">HTTPAdapterFactory</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/HTTPAuthenticationAdapterFactory.html">HTTPAuthenticationAdapterFactory</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SecureHTTPAdapterFactory.html">SecureHTTPAdapterFactory</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/ShadowsocksAdapterFactory.html">ShadowsocksAdapterFactory</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SpeedAdapterFactory.html">SpeedAdapterFactory</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Raw Socket.html">Raw Socket</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/SocketBaseType.html">SocketBaseType</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/RawSocketFactory.html">RawSocketFactory</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/RawTCPSocketProtocol.html">RawTCPSocketProtocol</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/RawTCPSocketDelegate.html">RawTCPSocketDelegate</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/GCDTCPSocket.html">GCDTCPSocket</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/NWTCPSocket.html">NWTCPSocket</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/TUNTCPSocket.html">TUNTCPSocket</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/NWUDPSocket.html">NWUDPSocket</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Rule.html">Rule</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/RuleManager.html">RuleManager</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Rule.html">Rule</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/DirectRule.html">DirectRule</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/AllRule.html">AllRule</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/CountryRule.html">CountryRule</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/DNSFailRule.html">DNSFailRule</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Connect Message.html">Connect Message</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/ConnectSession.html">ConnectSession</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/ConnectSession/EventSourceEnum.html">– EventSourceEnum</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/HTTPHeader.html">HTTPHeader</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/HTTPHeader/HTTPHeaderError.html">– HTTPHeaderError</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/HTTPHeader/URL.html">– URL</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="IP Stack.html">IP Stack</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/TUNInterface.html">TUNInterface</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/IPStackProtocol.html">IPStackProtocol</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/TCPStack.html">TCPStack</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/UDPDirectStack.html">UDPDirectStack</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="DNS.html">DNS</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/DNSClass.html">DNSClass</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/DNSMessageType.html">DNSMessageType</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/DNSReturnStatus.html">DNSReturnStatus</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/DNSType.html">DNSType</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/DNSMessage.html">DNSMessage</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/DNSNameConverter.html">DNSNameConverter</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/DNSQuery.html">DNSQuery</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/DNSResource.html">DNSResource</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/DNSResolverProtocol.html">DNSResolverProtocol</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/DNSResolverDelegate.html">DNSResolverDelegate</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/UDPDNSResolver.html">UDPDNSResolver</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/DNSServer.html">DNSServer</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/DNSSession.html">DNSSession</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/DNSSessionMatchResult.html">DNSSessionMatchResult</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/DNSSessionMatchType.html">DNSSessionMatchType</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="IP Packet.html">IP Packet</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/IPVersion.html">IPVersion</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/TransportProtocol.html">TransportProtocol</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/IPPacket.html">IPPacket</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/TransportProtocolParserProtocol.html">TransportProtocolParserProtocol</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/UDPProtocolParser.html">UDPProtocolParser</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Event.html">Event</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Event.html#/s:P5NEKit9EventType">EventType</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/ProxyServerEvent.html">ProxyServerEvent</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/TunnelEvent.html">TunnelEvent</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/AdapterSocketEvent.html">AdapterSocketEvent</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/ProxySocketEvent.html">ProxySocketEvent</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/RuleMatchEvent.html">RuleMatchEvent</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Observer.html">Observer</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/ObserverFactory.html">ObserverFactory</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Observer for Debug.html">Observer for Debug</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/DebugObserverFactory.html">DebugObserverFactory</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/DebugTunnelObserver.html">DebugTunnelObserver</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/DebugProxySocketObserver.html">DebugProxySocketObserver</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/DebugAdapterSocketObserver.html">DebugAdapterSocketObserver</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/DebugProxyServerObserver.html">DebugProxyServerObserver</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/DebugRuleManagerObserver.html">DebugRuleManagerObserver</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Configuration Parser.html">Configuration Parser</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Configuration.html">Configuration</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/AdapterFactoryParser.html">AdapterFactoryParser</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/RuleParser.html">RuleParser</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/ConfigurationParserError.html">ConfigurationParserError</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Utilities.html">Utilities</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Atomic.html">Atomic</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Box.html">Box</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/BinaryReadable.html">BinaryReadable</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/BinaryDataScanner.html">BinaryDataScanner</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Checksum.html">Checksum</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/HTTPAuthentication.html">HTTPAuthentication</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/HTTPStreamScanner.html">HTTPStreamScanner</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/HTTPStreamScanner/ReadAction.html">– ReadAction</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/HTTPStreamScanner/Result.html">– Result</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/HTTPStreamScanner/HTTPStreamScannerError.html">– HTTPStreamScannerError</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/IPAddress.html">IPAddress</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/IPAddress/Family.html">– Family</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/IPAddress/Address.html">– Address</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Port.html">Port</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/StreamScanner.html">StreamScanner</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Utils.html">Utils</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Utils/HTTPData.html">– HTTPData</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Utils/DNS.html">– DNS</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Utils/IP.html">– IP</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Utils/GeoIPLookup.html">– GeoIPLookup</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Utils/Random.html">– Random</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Other Classes.html">Other Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/CCCrypto.html">CCCrypto</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/CCCrypto/Algorithm.html">– Algorithm</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/CCCrypto/Mode.html">– Mode</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/DomainListRule.html">DomainListRule</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/DomainListRule/MatchCriterion.html">– MatchCriterion</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/GeoIP.html">GeoIP</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/HTTPURL.html">HTTPURL</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/IPPool.html">IPPool</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/IPRange.html">IPRange</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/IPRangeListRule.html">IPRangeListRule</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Libsodium.html">Libsodium</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/QueueFactory.html">QueueFactory</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/RejectAdapter.html">RejectAdapter</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/RejectAdapterFactory.html">RejectAdapterFactory</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/ResponseGenerator.html">ResponseGenerator</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/ResponseGeneratorFactory.html">ResponseGeneratorFactory</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SOCKS5Adapter.html">SOCKS5Adapter</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SOCKS5Adapter/SOCKS5AdapterStatus.html">– SOCKS5AdapterStatus</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SOCKS5Adapter/ReadTag.html">– ReadTag</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SOCKS5Adapter/WriteTag.html">– WriteTag</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SOCKS5AdapterFactory.html">SOCKS5AdapterFactory</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SodiumStreamCrypto.html">SodiumStreamCrypto</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SodiumStreamCrypto/Alogrithm.html">– Alogrithm</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Other Enums.html">Other Enums</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/CryptoAlgorithm.html">CryptoAlgorithm</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/CryptoOperation.html">CryptoOperation</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/HTTPAdapterError.html">HTTPAdapterError</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/HashAlgorithm.html">HashAlgorithm</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/IPInterval.html">IPInterval</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/IPMask.html">IPMask</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/IPRangeError.html">IPRangeError</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/UInt128Errors.html">UInt128Errors</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Other Extensions.html">Other Extensions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/Data.html">Data</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/SignedInteger.html">SignedInteger</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/String.html">String</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/UInt8.html">UInt8</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/UnsignedInteger.html">UnsignedInteger</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/Yaml.html">Yaml</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Other Functions.html">Other Functions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi1rFTVS_7UInt128S0__S0_">%(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi2reFTRVS_7UInt128S0__T_">%=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi1aFTVS_7UInt128S0__S0_">&amp;(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi2aeFTRVS_7UInt128S0__T_">&amp;=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi1mFTVS_7UInt128S0__S0_">*(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi2meFTRVS_7UInt128S0__T_">*=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi1pFTVS_7UInt128S0__S0_">+(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoP2ppFRVS_7UInt128S0_">++(_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitop2ppFRVS_7UInt128S0_">++(_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi2peFTRVS_7UInt128S0__T_">+=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi1sFTVS_7UInt128S0__S0_">-(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoP2ssFRVS_7UInt128S0_">--(_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitop2ssFRVS_7UInt128S0_">--(_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi2seFTRVS_7UInt128S0__T_">-=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi2drFTVS_7UInt128S0__T8quotientS0_9remainderS0__">/%(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi1dFTVS_7UInt128S0__S0_">/(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi2deFTRVS_7UInt128S0__T_">/=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi1lFTCS_9IPAddressS0__Sb">&lt;(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi1lFTVS_7UInt128S0__Sb">&lt;(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi2llFTVS_7UInt128S0__S0_">&lt;&lt;(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi3lleFTRVS_7UInt128S0__T_">&lt;&lt;=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi2leFTVS_7UInt128S0__Sb">&lt;=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi2eeFTCS_9IPAddressS0__Sb">==(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi2eeFTOCS_9IPAddress7AddressS1__Sb">==(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi2eeFTVS_11ConnectInfoS0__Sb">==(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi2eeFTVS_4PortS0__Sb">==(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi2eeFTVS_7UInt128S0__Sb">==(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi1gFTVS_7UInt128S0__Sb">&gt;(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi2geFTVS_7UInt128S0__Sb">&gt;=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi2ggFTVS_7UInt128S0__S0_">&gt;&gt;(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi3ggeFTRVS_7UInt128S0__T_">&gt;&gt;=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi1xFTVS_7UInt128S0__S0_">^(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi2xeFTRVS_7UInt128S0__T_">^=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi1oFTVS_7UInt128S0__S0_">|(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitoi2oeFTRVS_7UInt128S0__T_">|=(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other Functions.html#/s:F5NEKitop1tFVS_7UInt128S0_">~(_:)</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Other Protocols.html">Other Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/NWUDPSocketDelegate.html">NWUDPSocketDelegate</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/StreamCryptoProtocol.html">StreamCryptoProtocol</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Other Structs.html">Other Structs</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Buffer.html">Buffer</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/ConnectInfo.html">ConnectInfo</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/CryptoHelper.html">CryptoHelper</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/GlobalIntializer.html">GlobalIntializer</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/HMAC.html">HMAC</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/MD5Hash.html">MD5Hash</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Opt.html">Opt</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/UInt128.html">UInt128</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">

        <section class="section">
          <div class="section-content">
            
            <h1 id='nekit' class='heading'>NEKit</h1>

<p><a href="https://gitter.im/zhuhaow/NEKit?utm_source=badge&utm_medium=badge&utm_campaign=pr-badge&utm_content=badge"><img src="https://badges.gitter.im/zhuhaow/NEKit.svg" alt="Join the chat at https://gitter.im/zhuhaow/NEKit"></a> <a href="https://telegram.me/NEKitGroup"><img src="https://img.shields.io/badge/chat-on%20Telegram-blue.svg" alt="Join the chat at https://telegram.me/NEKitGroup"></a> <a href="https://travis-ci.org/zhuhaow/NEKit"><img src="https://travis-ci.org/zhuhaow/NEKit.svg?branch=master" alt="Build Status"></a> <a href="https://github.com/zhuhaow/NEKit/releases"><img src="https://img.shields.io/github/release/zhuhaow/NEKit.svg" alt="GitHub release"></a> <a href="https://codeclimate.com/github/zhuhaow/NEKit"><img src="https://codeclimate.com/github/zhuhaow/NEKit/badges/gpa.svg" alt="Code Climate"></a> <a href="https://codecov.io/gh/zhuhaow/NEKit"><img src="https://codecov.io/gh/zhuhaow/NEKit/branch/master/graph/badge.svg" alt="codecov"></a> <a href="https://github.com/Carthage/Carthage"><img src="https://img.shields.io/badge/Carthage-compatible-4BC51D.svg?style=flat" alt="Carthage compatible"></a> <a href="LICENSE.md"><img src="https://img.shields.io/badge/license-BSD_3--Clause-blue.svg" alt="GitHub license"></a></p>

<p>A toolkit for Network Extension Framework.</p>

<p>NEKit is the successor of <a href="https://github.com/zhuhaow/soca-ios">Soca</a>. The main goal of NEKit is to provide things needed in building a Network Extension app with <code>NETunnelProvider</code> to bypass network filtering and censorship while keep the framework as non-opinionated as possible.</p>

<p><strong>NEKit does not depend on Network Extension framework. You can use NEKit without Network Extension entitlement to build a rule based proxy in a few lines.</strong></p>

<p><strong>Do not enable <code>TUNInterface</code> as of now since it is not working.</strong></p>

<p>There are two demos that you should check out.</p>

<p><a href="https://github.com/zhuhaow/SpechtLite">SpechtLite</a> does not require Network Extension and anyone can use it.</p>

<p><a href="https://github.com/zhuhaow/Specht">Specht</a> is another demo that requires Network Extension entitlement.</p>

<p>Currently, NEKit supports:</p>

<ul>
<li>Forward requests through different proxies based on remote host location, remote host domain or the connection speed of proxies.</li>
<li>Integrated tun2socks framework to reassemble TCP packets into TCP flows.</li>
<li>A DNS server that rewrites request and response.</li>
<li>Some tools to build IP packets.</li>
<li>&hellip;</li>
</ul>

<p>Check document <a href="https://zhuhaow.github.io/NEKit">here</a>.</p>

<p>Also, you may be more interested in <a href="https://github.com/shadowsocks/Potatso-iOS">Potatso</a> if you just need an open source iOS app with GUI supporting shadowsocks.</p>

<p><strong><a href="https://itunes.apple.com/cn/app/wingy-mian-fei-banvpn-ke-hu/id1148026741?mt=8">Wingy</a> is a free app built with NEKit available on App Store for your iDevice.</strong> Note Wingy is not created by or affiliated with me.</p>

<p>If you have any questions (not bug report), <strong>please join Gitter or Telegram instead of opening an issue</strong>.</p>
<h2 id='principle' class='heading'>Principle</h2>

<p>NEKit tries to be as flexible and non-opionated as possible. </p>

<p>However, it is not always as modular as you may think if you want to reproduce transport layer from network layer.</p>

<p>NEKit follows one fundamental principle to keep the best network performance: The device connecting to target server directly resolves the domain. </p>

<p>This should not be a problem if the applications on your device connect to the local proxy server directly, where we can get the request domain information then send that to remote proxy server if needed.</p>

<p>But consider that if an application tries to make a socket connection by itself, which generally consists of two steps: </p>

<ol>
<li>Make a DNS lookup to find the IP address of the target server.</li>
<li>Connect to the remote server by socket API provided by the system.</li>
</ol>

<p>We can read only two independent things from the TUN interface, a UDP packet containing the DNS lookup request and a TCP flow consisting of a serial of TCP packets. So there is no way we can know the initial request domain for the TCP flow. And since there may be multiple domains served on the same host, we can not get the origin domain by saving the DNS response and looking that up reversely later.</p>

<p>The only solution is to create a fake IP pool and assign each requested domain with a unique fake IP so we can look that up reversely. Every connection needs to look that up from the DNS server afterwards; this is the only non-modular part of NEKit which is already encapsulated in <code>ConnectSession</code>.</p>
<h2 id='usage' class='heading'>Usage</h2>
<h3 id='add-it-to-you-project' class='heading'>Add it to you project</h3>

<p>I recommend adding this project to your project, which is easier to debug. </p>

<p>However, you can still use it with Carthage (you&rsquo;ll need Carthage anyway since NEKit uses Carthage) by adding</p>
<pre class="highlight plaintext"><code>github "zhuhaow/NEKit"
</code></pre>

<p>to you <code>Cartfile</code>.</p>

<p>Use 
<code>carthage update --no-use-binaries --platform mac,ios</code>
to install all frameworks. Do not use pre-compiled binaries since some of them might be buggy.</p>
<h3 id='overview' class='heading'>Overview</h3>

<p>NEKit basically consists of two parts, a proxy server forwarding socket data based on user defined rules and an IP stack reassembling IP packets back to TCP flow as a socket.</p>
<h3 id='rule-manager' class='heading'>Rule manager</h3>

<p>Before starting any proxy server, we need to define rules.</p>

<p>Each rule consists of two parts, one defining what kinding of request matches this rule and the other defining what adapter to use. An adapter represents the abstraction of a socket connection to a remote proxy server (or remote host). We use <code>AdapterFactory</code> to build adapters. </p>

<p>NEKit provides <code>AdapterSocket</code> supporting HTTP/HTTPS/SOCK5 proxy and Shadowsocks(AES-128-CFB/AES-192-CFB/AES-256-CFB/chacha20/salsa20/rc4-md5). Let me know if there is any other type of proxy needed. You can also implement your own <code>AdapterSocket</code>.</p>
<pre class="highlight swift"><code><span class="c1">// Define remote adapter first</span>
<span class="k">let</span> <span class="nv">directAdapterFactory</span> <span class="o">=</span> <span class="kt">DirectAdapterFactory</span><span class="p">()</span>
<span class="k">let</span> <span class="nv">httpAdapterFactory</span> <span class="o">=</span> <span class="kt">HTTPAdapterFactory</span><span class="p">(</span><span class="nv">serverHost</span><span class="p">:</span> <span class="s">"remote.http.proxy"</span><span class="p">,</span> <span class="nv">serverPort</span><span class="p">:</span> <span class="mi">3128</span><span class="p">,</span> <span class="nv">auth</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">ssAdapterFactory</span> <span class="o">=</span> <span class="kt">ShadowsocksAdapterFactory</span><span class="p">(</span><span class="nv">serverHost</span><span class="p">:</span> <span class="s">"remote.ss.proxy"</span><span class="p">,</span> <span class="nv">serverPort</span><span class="p">:</span> <span class="mi">7077</span><span class="p">,</span> <span class="nv">encryptMethod</span><span class="p">:</span> <span class="s">"AES-256-CFB"</span><span class="p">,</span> <span class="nv">password</span><span class="p">:</span> <span class="s">"1234567890"</span><span class="p">)</span>

<span class="c1">// Then create rules</span>
<span class="k">let</span> <span class="nv">chinaRule</span> <span class="o">=</span> <span class="kt">CountryRule</span><span class="p">(</span><span class="nv">countryCode</span><span class="p">:</span> <span class="s">"CN"</span><span class="p">,</span> <span class="nv">match</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nv">adapterFactory</span><span class="p">:</span> <span class="n">directAdapterFactory</span><span class="p">)</span>
<span class="c1">// `urls` are regular expressions</span>
<span class="k">let</span> <span class="nv">listRule</span> <span class="o">=</span> <span class="k">try!</span> <span class="kt">ListRule</span><span class="p">(</span><span class="nv">adapterFactory</span><span class="p">:</span> <span class="n">ssAdapterFactory</span><span class="p">,</span> <span class="nv">urls</span><span class="p">:</span> <span class="p">[</span><span class="s">"some</span><span class="se">\\</span><span class="s">.site</span><span class="se">\\</span><span class="s">.does</span><span class="se">\\</span><span class="s">.not</span><span class="se">\\</span><span class="s">.exists"</span><span class="p">])</span>
<span class="k">let</span> <span class="nv">allRule</span> <span class="o">=</span> <span class="kt">AllRule</span><span class="p">(</span><span class="nv">adapterFactory</span><span class="p">:</span> <span class="n">httpAdapterFactory</span><span class="p">)</span>

<span class="c1">// Create rule manager, rules will be matched in order.</span>
<span class="k">let</span> <span class="nv">manager</span> <span class="o">=</span> <span class="kt">RuleManager</span><span class="p">(</span><span class="nv">fromRules</span><span class="p">:</span> <span class="p">[</span><span class="n">listRule</span><span class="p">,</span> <span class="n">chinaRule</span><span class="p">,</span> <span class="n">allRule</span><span class="p">],</span> <span class="nv">appendDirect</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>

<span class="c1">// Set this manager as the active manager</span>
<span class="kt">RuleManager</span><span class="o">.</span><span class="n">currentManager</span> <span class="o">=</span> <span class="n">ruleManager</span>
</code></pre>

<p>There is also <code>Configuration</code> to load rules from a Yaml config file. But that is not recommended.</p>
<h3 id='proxy-server' class='heading'>Proxy server</h3>

<p>Now we can start a HTTP/SOCKS5 proxy server locally.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">server</span> <span class="o">=</span> <span class="kt">GCDHTTPProxyServer</span><span class="p">(</span><span class="nv">address</span><span class="p">:</span> <span class="kt">IPv4Address</span><span class="p">(</span><span class="nv">fromString</span><span class="p">:</span> <span class="s">"127.0.0.1"</span><span class="p">),</span> <span class="nv">port</span><span class="p">:</span> <span class="kt">Port</span><span class="p">(</span><span class="nv">port</span><span class="p">:</span> <span class="mi">9090</span><span class="p">)</span>
<span class="k">try!</span> <span class="n">server</span><span class="o">.</span><span class="nf">start</span><span class="p">()</span>
</code></pre>

<p>Now there is a HTTP proxy server running on <code>127.0.0.1:9090</code> which will forward requests based on rules defined in <code>RuleManager.currentManager</code>.</p>

<p>If you do not want to handle IP packets, then that&rsquo;s it, just set the proxy to <code>127.0.0.1:9090</code> in System Preferences and you are good to go.</p>

<p>If you want to read on, you will have to request Network Extention entitlement from Apple. </p>

<p>But even if you use NetworkExtention to set up the network proxy, it does not mean you have to process packets, just do not route anything to the TUN interface and do not set up <code>IPStack</code>. For iOS, if you claim you have implemented it but just do nothing the users probably will never notice.</p>
<h3 id='ip-stack' class='heading'>IP stack</h3>

<p>Assuming you already set up a working extension with correct routing configurations (Google how, this is not trivial).</p>

<p>In </p>
<pre class="highlight swift"><code><span class="nf">startTunnelWithOptions</span><span class="p">(</span><span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span> <span class="p">:</span> <span class="kt">NSObject</span><span class="p">]?,</span> <span class="nv">completionHandler</span><span class="p">:</span> <span class="p">(</span><span class="kt">NSError</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span>
</code></pre>

<p>set <code>RuleManager</code> and start proxy server(s) and then create an instance representing the TUN interface by</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">stack</span> <span class="o">=</span> <span class="kt">TUNInterface</span><span class="p">(</span><span class="nv">packetFlow</span><span class="p">:</span> <span class="n">packetFlow</span><span class="p">)</span>
</code></pre>

<p>We also have to set</p>
<pre class="highlight swift"><code><span class="kt">RawSocketFactory</span><span class="o">.</span><span class="kt">TunnelProvider</span> <span class="o">=</span> <span class="k">self</span>
</code></pre>

<p>to create socket to connect to remote servers with <code>NETunnelProvider</code>.</p>

<p>Then we need to register ip stacks implementing <code>IPStackProtocol</code> to process IP packets.</p>

<p>NEKit provides several stacks.</p>
<h4 id='tcpstack' class='heading'>TCPStack</h4>

<p><code>TCPStack</code> process TCP packets and reassembles them back into TCP flows then send them to the proxy server specified by <code>proxyServer</code> variable. You have to set <code>proxyServer</code> before registering <code>TCPStack</code> to <code>TUNInterface</code>.</p>
<h4 id='dnsserver' class='heading'>DNSServer</h4>

<p>DNS server is implemented as an IP stack processing UDP packets send to it.</p>

<p>First create an DNS server with a fake IP pool. (You should use fake IP, but you can disable it if you want to by set it to nil.)</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">fakeIPPool</span> <span class="o">=</span> <span class="kt">IPv4Pool</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="kt">IPv4Address</span><span class="p">(</span><span class="nv">fromString</span><span class="p">:</span> <span class="s">"172.169.1.0"</span><span class="p">),</span> <span class="nv">end</span><span class="p">:</span> <span class="kt">IPv4Address</span><span class="p">(</span><span class="nv">fromString</span><span class="p">:</span> <span class="s">"172.169.255.0"</span><span class="p">))</span>
<span class="k">let</span> <span class="nv">dnsServer</span> <span class="o">=</span> <span class="kt">DNSServer</span><span class="p">(</span><span class="nv">address</span><span class="p">:</span> <span class="kt">IPv4Address</span><span class="p">(</span><span class="nv">fromString</span><span class="p">:</span> <span class="s">"172.169.0.1"</span><span class="p">),</span> <span class="nv">port</span><span class="p">:</span> <span class="kt">Port</span><span class="p">(</span><span class="nv">port</span><span class="p">:</span> <span class="mi">53</span><span class="p">),</span> <span class="nv">fakeIPPool</span><span class="p">:</span> <span class="n">fakeIPPool</span><span class="p">)</span>
</code></pre>

<p>Then we have to define how to resolve the DNS requests, NEKit provides the most trivial one which sends the request to remote DNS server directly with UDP protocol, you can do anything you want by implementing <code>DNSResolverProtocol</code>.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">resolver</span> <span class="o">=</span> <span class="kt">UDPDNSResolver</span><span class="p">(</span><span class="nv">address</span><span class="p">:</span> <span class="kt">IPv4Address</span><span class="p">(</span><span class="nv">fromString</span><span class="p">:</span> <span class="s">"114.114.114.114"</span><span class="p">),</span> <span class="nv">port</span><span class="p">:</span> <span class="kt">Port</span><span class="p">(</span><span class="nv">port</span><span class="p">:</span> <span class="mi">53</span><span class="p">))</span>
<span class="n">dnsServer</span><span class="o">.</span><span class="nf">registerResolver</span><span class="p">(</span><span class="n">resolver</span><span class="p">)</span>
</code></pre>

<p>It is very important to set </p>
<pre class="highlight swift"><code><span class="kt">DNSServer</span><span class="o">.</span><span class="n">currentServer</span> <span class="o">=</span> <span class="n">dnsServer</span>
</code></pre>

<p>so we can look up the fake IP reversely.</p>
<h4 id='udpdirectstack' class='heading'>UDPDirectStack</h4>

<p><code>UDPDirectStack</code> sends and reads UDP packets to and from remote server directly.</p>

<p>You can register these stack to TUN interface by</p>
<pre class="highlight swift"><code><span class="n">interface</span><span class="o">.</span><span class="nf">registerStack</span><span class="p">(</span><span class="n">dnsServer</span><span class="p">)</span>
<span class="c1">// Note this sends out every UDP packets directly so this must comes after any other stack that processes UDP packets.</span>
<span class="n">interface</span><span class="o">.</span><span class="nf">registerStack</span><span class="p">(</span><span class="kt">UDPDirectStack</span><span class="p">())</span>
<span class="n">interface</span><span class="o">.</span><span class="nf">registerStack</span><span class="p">(</span><span class="kt">TCPStack</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
</code></pre>

<p>When everything is set up, you should start processing packets by calling <code>interface.start()</code> in the completion handler of <code>setTunnelNetworkSettings</code>.</p>
<h2 id='event' class='heading'>Event</h2>

<p>You can use <code>Observer&lt;T&gt;</code> to observe the events in proxy servers and sockets. Check out observers in <code>DebugObserver.swift</code> as an example.</p>
<h2 id='dive-in' class='heading'>Dive in</h2>
<h3 id='framework-overview' class='heading'>Framework overview</h3>

<p>The structure of the proxy server is given as follows:</p>
<pre class="highlight plaintext"><code>┌──────────────────────────────────────────────────┐
│                                                  │
│                   ProxyServer                    │
│                                                  │
├──────┬───┬──────┬───┬──────┬───┬──────┬───┬──────┤
│Tunnel│   │Tunnel│   │Tunnel│   │Tunnel│   │Tunnel│
└──────┘   └──────┘   └───▲──┘   └──────┘   └──────┘
                         ╱ ╲                        
                ╱───────╱   ╲─────╲                 
               ╱                   ╲                
     ┌────────▼────────┐   ┌────────▼────────┐      
     │   ProxySocket   │   │  AdapterSocket  │      
     └────────▲────────┘   └────────▲────────┘      
              │                     │               
              │                     │               
     ┌────────▼────────┐   ┌────────▼────────┐      
     │RawSocketProtocol│   │RawSocketProtocol│      
     └────────▲────────┘   └────────▲────────┘      
              │                     │               
              │                     │               
       ╔══════▼═══════╗     ╔═══════▼══════╗        
       ║    LOCAL     ║     ║    REMOTE    ║        
       ╚══════════════╝     ╚══════════════╝        
</code></pre>

<p>When a new socket is accepted from the listening socket of the proxy server, it is wrapped in some implementation of <code>RawSocketProtocol</code> as a raw socket which just reads and writes data. </p>

<p>Then it is wrapped in a subclass of <code>ProxySocket</code> which encapsulates the proxy logic. </p>

<p>The <code>TCPStack</code> wraps the reassembled TCP flow (<code>TUNTCPSocket</code>) in <code>DirectProxySocket</code> then send it to the <code>mainProxy</code> server.</p>

<p>Similarly, <code>AdapterSocket</code> encapsulated the logic of how to connect to remote and process the data flow.</p>

<p>Pretty much everything of NEKit follows the <a href="https://en.wikipedia.org/wiki/Delegation_pattern">delegation pattern</a>. If you are not familiar with that, you should learn it first, probabaly by learning how to use <a href="https://github.com/robbiehanson/CocoaAsyncSocket">CocoaAsyncSocket</a> (note that the sockets in NEKit are <strong>not</strong> thread-safe which is different from GCDAsyncSocket).</p>
<h3 id='the-lifetime-of-a-code-tunnel-code' class='heading'>The lifetime of a <code>Tunnel</code></h3>

<p>When a <code>RawSocketProtocol</code> socket is accepted or created by <code>TCPStack</code>, it is wrapped in a <code>ProxySocket</code> then in a <code>Tunnel</code>. The <code>Tunnel</code> will call <code>proxySocket.openSocket()</code> to let the proxy socket start process data. </p>

<p>When the <code>ProxySocket</code> read enough data to build a <code>ConnectSession</code>, it calls <code>func didReceiveRequest(request: ConnectSession, from: ProxySocket)</code> of the <code>delegate</code> (which should be the <code>Tunnel</code>). </p>

<p>The <code>Tunnel</code> then matches this request in <code>RuleManager</code> to get the corresponding <code>AdapterFactory</code>. Then <code>func openSocketWithSession(session: ConnectSession)</code> of the produced <code>AdapterSocket</code> is called to connect to remote server.</p>

<p>The <code>AdapterSocket</code> calls <code>func didConnect(adapterSocket: AdapterSocket, withResponse response: ConnectResponse)</code> of the <code>Tunnel</code> to let the <code>ProxySocket</code> has a chance to respond to remote response. (This is ignored as of now.) </p>

<p>Finally, when the <code>ProxySocket</code> and <code>AdapterSocket</code> are ready to forward data, they should call <code>func readyToForward(socket: SocketProtocol)</code> of the <code>Tunnel</code> to let it know. When both sides are ready, the tunnel will read from both sides and then send the received data to the other side intact.</p>

<p>When any side of the tunnel is disconnected, the <code>func didDisconnect(socket: SocketProtocol)</code> is called then both sides are closed actively. The <code>Tunnel</code> will be released when both sides disconnect successfully.</p>
<h2 id='todo' class='heading'>TODO</h2>

<ul>
<li>[ ] Documents.</li>
<li>[ ] IPv6 support.</li>
</ul>
<h2 id='license' class='heading'>License</h2>

<p>Copyright &copy; 2016, Zhuhao Wang
All rights reserved.</p>

<p>Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:</p>

<ul>
<li><p>Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.</p></li>
<li><p>Redistributions in binary form must reproduce the above copyright notice,
this list of conditions and the following disclaimer in the documentation
and/or other materials provided with the distribution.</p></li>
<li><p>Neither the name of NEKit nor the names of its
contributors may be used to endorse or promote products derived from
this software without specific prior written permission.</p></li>
</ul>

<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS <q>AS IS</q> AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>

          </div>
        </section>


      </article>
    </div>
    <section class="footer">
      <p>&copy; 2017 <a class="link" href="" target="_blank" rel="external">Zhuhao Wang</a>. All rights reserved. (Last updated: 2017-07-10)</p>
      <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.8.3</a>, a <a class="link" href="http://realm.io" target="_blank" rel="external">Realm</a> project.</p>
    </section>
  </body>
</div>
</html>
